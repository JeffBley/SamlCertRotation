<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAML Cert Rotation - Diagnostics</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #e0e0e0; padding: 20px; }
        h1 { color: #4fc3f7; margin-bottom: 20px; }
        h2 { color: #81d4fa; margin: 20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        h3 { color: #b3e5fc; margin: 15px 0 8px; }
        .card { background: #16213e; border-radius: 8px; padding: 16px; margin-bottom: 16px; border: 1px solid #333; }
        .status { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-ok { background: #1b5e20; color: #a5d6a7; }
        .status-warn { background: #e65100; color: #ffcc80; }
        .status-error { background: #b71c1c; color: #ef9a9a; }
        .status-info { background: #0d47a1; color: #90caf9; }
        pre { background: #0a0e27; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-all; }
        table { width: 100%; border-collapse: collapse; margin: 8px 0; }
        th { text-align: left; padding: 8px; background: #0d47a1; color: #e3f2fd; font-size: 13px; }
        td { padding: 8px; border-bottom: 1px solid #263238; font-size: 13px; }
        td:first-child { font-weight: bold; color: #90caf9; white-space: nowrap; width: 280px; }
        .btn { padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 8px; margin-bottom: 8px; }
        .btn-primary { background: #1565c0; color: white; }
        .btn-primary:hover { background: #1976d2; }
        .btn-danger { background: #c62828; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        .loading { color: #ffb74d; font-style: italic; }
        .app-row { cursor: pointer; }
        .app-row:hover { background: #1a237e; }
        .collapse-content { display: none; }
        .collapse-content.show { display: table-row; }
        #diagnosticsOutput { margin-top: 10px; }
        .role-badge { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 4px; font-size: 12px; }
        .role-admin { background: #1b5e20; color: #a5d6a7; }
        .role-reader { background: #0d47a1; color: #90caf9; }
        .role-authenticated { background: #4a148c; color: #ce93d8; }
        .role-anonymous { background: #263238; color: #b0bec5; }
        .role-other { background: #e65100; color: #ffcc80; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .summary-item { background: #0d47a1; border-radius: 8px; padding: 12px; text-align: center; }
        .summary-value { font-size: 28px; font-weight: bold; color: #e3f2fd; }
        .summary-label { font-size: 12px; color: #90caf9; margin-top: 4px; }
    </style>
</head>
<body>
    <h1>&#128269; SAML Cert Rotation - Diagnostics</h1>
    <p style="margin-bottom:16px;color:#aaa;">This page calls <code>/.auth/me</code> and <code>/api/debug/diagnostics</code> to help troubleshoot auth, role enrichment, and custom security attribute issues.</p>

    <div>
        <button class="btn btn-primary" onclick="runAllDiagnostics()">Run All Diagnostics</button>
        <button class="btn btn-primary" onclick="runAuthMe()">/.auth/me Only</button>
        <button class="btn btn-primary" onclick="runApiDiagnostics()">API Diagnostics Only</button>
        <button class="btn btn-danger" onclick="document.getElementById('diagnosticsOutput').innerHTML = ''">Clear</button>
    </div>

    <div id="diagnosticsOutput"></div>

    <script>
        const out = () => document.getElementById('diagnosticsOutput');

        function roleBadge(role) {
            const cls = role === 'admin' ? 'role-admin'
                : role === 'reader' ? 'role-reader'
                : role === 'authenticated' ? 'role-authenticated'
                : role === 'anonymous' ? 'role-anonymous'
                : 'role-other';
            return `<span class="role-badge ${cls}">${esc(role)}</span>`;
        }

        function statusBadge(text, level) {
            return `<span class="status status-${level}">${esc(text)}</span>`;
        }

        function esc(str) {
            const d = document.createElement('div');
            d.textContent = String(str ?? '');
            return d.innerHTML;
        }

        async function runAllDiagnostics() {
            out().innerHTML = '<p class="loading">Running all diagnostics...</p>';
            const [authMe, apiDiag] = await Promise.allSettled([
                fetchAuthMe(),
                fetchApiDiagnostics()
            ]);
            out().innerHTML = '';
            renderAuthMe(authMe.status === 'fulfilled' ? authMe.value : { error: authMe.reason?.message });
            renderApiDiagnostics(apiDiag.status === 'fulfilled' ? apiDiag.value : { error: apiDiag.reason?.message });
            renderVerdict(
                authMe.status === 'fulfilled' ? authMe.value : null,
                apiDiag.status === 'fulfilled' ? apiDiag.value : null
            );
        }

        async function runAuthMe() {
            out().innerHTML = '<p class="loading">Fetching /.auth/me...</p>';
            try {
                const data = await fetchAuthMe();
                out().innerHTML = '';
                renderAuthMe(data);
            } catch (e) {
                out().innerHTML = `<div class="card"><h2>Error</h2><pre>${esc(e.message)}</pre></div>`;
            }
        }

        async function runApiDiagnostics() {
            out().innerHTML = '<p class="loading">Fetching /api/debug/diagnostics...</p>';
            try {
                const data = await fetchApiDiagnostics();
                out().innerHTML = '';
                renderApiDiagnostics(data);
            } catch (e) {
                out().innerHTML = `<div class="card"><h2>Error</h2><pre>${esc(e.message)}</pre></div>`;
            }
        }

        async function fetchAuthMe() {
            const resp = await fetch('/.auth/me', { credentials: 'include' });
            if (!resp.ok) return { httpStatus: resp.status, error: resp.statusText };
            return await resp.json();
        }

        async function fetchApiDiagnostics() {
            const resp = await fetch('/api/debug/diagnostics', { credentials: 'include' });
            if (!resp.ok) {
                const text = await resp.text().catch(() => '');
                return { httpStatus: resp.status, error: resp.statusText, body: text };
            }
            return await resp.json();
        }

        function renderAuthMe(data) {
            let html = '<div class="card"><h2>1. SWA Auth Context (/.auth/me)</h2>';

            if (data?.error) {
                html += `<p>${statusBadge('ERROR', 'error')} ${esc(data.error)}</p>`;
                if (data.httpStatus) html += `<p>HTTP ${data.httpStatus}</p>`;
                html += '</div>';
                out().innerHTML += html;
                return;
            }

            const principal = Array.isArray(data)
                ? (data.length > 0 ? data[0]?.clientPrincipal : null)
                : data?.clientPrincipal ?? null;

            if (!principal) {
                html += `<p>${statusBadge('NOT AUTHENTICATED', 'error')} No client principal found in /.auth/me response</p>`;
                html += `<pre>${esc(JSON.stringify(data, null, 2))}</pre>`;
                html += '</div>';
                out().innerHTML += html;
                return;
            }

            // Identity
            html += '<h3>Identity</h3><table>';
            html += `<tr><td>Identity Provider</td><td>${esc(principal.identityProvider)}</td></tr>`;
            html += `<tr><td>User ID</td><td>${esc(principal.userId)}</td></tr>`;
            html += `<tr><td>User Details</td><td>${esc(principal.userDetails)}</td></tr>`;
            html += '</table>';

            // Roles - THE KEY DIAGNOSTIC
            html += '<h3>User Roles (from SWA)</h3>';
            const roles = principal.userRoles || [];
            if (roles.length === 0) {
                html += `<p>${statusBadge('NO ROLES', 'error')} userRoles array is empty</p>`;
            } else {
                html += '<p>' + roles.map(r => roleBadge(r)).join(' ') + '</p>';

                const hasAdmin = roles.includes('admin');
                const hasReader = roles.includes('reader');
                if (!hasAdmin && !hasReader) {
                    html += `<p>${statusBadge('MISSING CUSTOM ROLES', 'error')} Only standard roles present. GetRoles may not be enriching roles.</p>`;
                } else {
                    html += `<p>${statusBadge('ROLES ENRICHED', 'ok')} Custom roles present from GetRoles function.</p>`;
                }
            }

            // Claims
            html += '<h3>Claims</h3>';
            const claims = principal.claims || [];
            if (claims.length === 0) {
                html += `<p>${statusBadge('NO CLAIMS', 'warn')} No claims in client principal</p>`;
            } else {
                html += '<table><tr><th>Type</th><th>Value</th></tr>';
                for (const claim of claims) {
                    const ct = claim.typ || claim.type || '';
                    const cv = claim.val || claim.value || '';
                    const isRoleClaim = ct.toLowerCase() === 'roles' || ct.toLowerCase().includes('/role');
                    html += `<tr><td>${esc(ct)}${isRoleClaim ? ' ' + statusBadge('ROLE', 'info') : ''}</td><td>${esc(cv)}</td></tr>`;
                }
                html += '</table>';

                // Check for app role claims
                const roleClaims = claims.filter(c => {
                    const t = (c.typ || c.type || '').toLowerCase();
                    return t === 'roles' || t.includes('/role');
                });
                if (roleClaims.length > 0) {
                    const roleValues = roleClaims.map(c => c.val || c.value || '');
                    html += `<p>${statusBadge('APP ROLE CLAIMS FOUND', 'ok')} Values: ${roleValues.map(v => '<code>' + esc(v) + '</code>').join(', ')}</p>`;
                } else {
                    html += `<p>${statusBadge('NO APP ROLE CLAIMS', 'warn')} No "roles" claims found. Check Enterprise App role assignment.</p>`;
                }
            }

            // Raw JSON
            html += '<h3>Raw /.auth/me Response</h3>';
            html += `<pre>${esc(JSON.stringify(data, null, 2))}</pre>`;
            html += '</div>';
            out().innerHTML += html;
        }

        function renderApiDiagnostics(data) {
            let html = '<div class="card"><h2>2. API Diagnostics (/api/debug/diagnostics)</h2>';

            if (data?.error) {
                html += `<p>${statusBadge('ERROR', 'error')} ${esc(data.error)}</p>`;
                if (data.httpStatus) html += `<p>HTTP ${data.httpStatus}</p>`;
                if (data.body) html += `<pre>${esc(data.body)}</pre>`;
                html += '</div>';
                out().innerHTML += html;
                return;
            }

            // Parsed Identity (server-side)
            html += '<h3>Server-Side Parsed Identity</h3>';
            const id = data.parsedIdentity;
            if (!id) {
                html += `<p>${statusBadge('NOT AUTHENTICATED', 'error')} Server could not parse any identity from the request.</p>`;
            } else {
                html += '<table>';
                html += `<tr><td>User ID</td><td>${esc(id.userId)}</td></tr>`;
                html += `<tr><td>Is Authenticated</td><td>${id.isAuthenticated ? statusBadge('YES', 'ok') : statusBadge('NO', 'error')}</td></tr>`;
                html += `<tr><td>Roles</td><td>${(id.roles || []).map(r => roleBadge(r)).join(' ') || statusBadge('NONE', 'error')}</td></tr>`;
                html += '</table>';
            }

            // Configuration
            html += '<h3>Function App Configuration</h3>';
            const config = data.configuration;
            if (config) {
                html += '<table>';
                const configFields = [
                    ['TenantId', config.tenantId],
                    ['SWA_HOSTNAME', config.swA_HOSTNAME ?? config.swa_HOSTNAME],
                    ['SWA_DEFAULT_HOSTNAME', config.swA_DEFAULT_HOSTNAME ?? config.swa_DEFAULT_HOSTNAME],
                    ['AAD_CLIENT_ID', config.aaD_CLIENT_ID ?? config.aad_CLIENT_ID],
                    ['SWA_AAD_CLIENT_ID', config.swA_AAD_CLIENT_ID ?? config.swa_AAD_CLIENT_ID],
                    ['SWA_ADMIN_APP_ROLE', config.swA_ADMIN_APP_ROLE ?? config.swa_ADMIN_APP_ROLE],
                    ['SWA_READER_APP_ROLE', config.swA_READER_APP_ROLE ?? config.swa_READER_APP_ROLE],
                    ['CustomSecurityAttributeSet', config.customSecurityAttributeSet],
                    ['CustomSecurityAttributeName', config.customSecurityAttributeName],
                ];
                for (const [name, val] of configFields) {
                    const isNotSet = !val || val === 'NOT SET' || val.startsWith('NOT SET');
                    html += `<tr><td>${esc(name)}</td><td>${isNotSet ? statusBadge(val || 'NOT SET', 'warn') : esc(val)}</td></tr>`;
                }
                
                // Trusted issuers
                const issuers = config.trustedSwaIssuers || [];
                html += `<tr><td>Trusted SWA Issuers</td><td>${issuers.length > 0 ? issuers.map(i => '<code>' + esc(i) + '</code>').join('<br>') : statusBadge('NONE', 'error')}</td></tr>`;
                
                const audiences = config.allowedAudiences || [];
                html += `<tr><td>Allowed Audiences</td><td>${audiences.length > 0 ? audiences.map(a => '<code>' + esc(a) + '</code>').join('<br>') : statusBadge('NONE', 'warn')}</td></tr>`;
                html += '</table>';
            }

            // Auth tokens received by server
            html += '<h3>Auth Tokens Received by Server</h3>';
            const tokens = data.authTokens || [];
            if (tokens.length === 0) {
                html += `<p>${statusBadge('NO TOKENS', 'warn')} No auth tokens found in request headers.</p>`;
            } else {
                for (const tok of tokens) {
                    html += `<div style="margin:8px 0;padding:8px;background:#0a0e27;border-radius:6px;">`;
                    html += `<strong>Source:</strong> ${esc(tok.source)}<br>`;
                    if (tok.error) {
                        html += `${statusBadge('PARSE ERROR', 'error')} ${esc(tok.error)}`;
                    } else {
                        html += `<strong>Issuer:</strong> ${esc(tok.issuer)}<br>`;
                        html += `<strong>Audiences:</strong> ${(tok.audiences || []).join(', ')}<br>`;
                        html += `<strong>Valid:</strong> ${tok.validFrom} → ${tok.validTo}<br>`;
                        html += `<strong>Claims (${(tok.claims || []).length}):</strong>`;
                        html += '<table><tr><th>Type</th><th>Value</th></tr>';
                        for (const c of (tok.claims || [])) {
                            // Truncate long values
                            const displayVal = c.value && c.value.length > 200 ? c.value.substring(0, 200) + '...' : c.value;
                            html += `<tr><td>${esc(c.type)}</td><td>${esc(displayVal)}</td></tr>`;
                        }
                        html += '</table>';
                    }
                    html += '</div>';
                }
            }

            // Client Principal Header
            html += '<h3>x-ms-client-principal Header (decoded)</h3>';
            const cp = data.clientPrincipalHeader;
            if (cp === 'not present') {
                html += `<p>${statusBadge('NOT PRESENT', 'warn')} SWA did not send x-ms-client-principal header.</p>`;
            } else if (typeof cp === 'string') {
                html += `<p>${statusBadge('ERROR', 'error')} ${esc(cp)}</p>`;
            } else {
                html += `<pre>${esc(JSON.stringify(cp, null, 2))}</pre>`;
            }

            // SAML Apps / CSA
            html += '<h3>SAML Apps & Custom Security Attributes</h3>';
            const apps = data.samlApps;
            if (apps?.error) {
                html += `<p>${statusBadge('ERROR', 'error')} ${esc(apps.error)}</p>`;
                if (apps.type) html += `<p>Exception type: ${esc(apps.type)}</p>`;
            } else if (apps) {
                html += '<div class="summary-grid">';
                html += `<div class="summary-item"><div class="summary-value">${apps.totalCount}</div><div class="summary-label">Total SAML Apps</div></div>`;
                html += `<div class="summary-item"><div class="summary-value">${apps.withAutoRotateSet}</div><div class="summary-label">Auto-Rotate Set</div></div>`;
                html += `<div class="summary-item"><div class="summary-value">${apps.withAutoRotateNull}</div><div class="summary-label">Auto-Rotate NULL</div></div>`;
                html += '</div>';

                if (apps.withAutoRotateNull === apps.totalCount && apps.totalCount > 0) {
                    html += `<p>${statusBadge('ALL NULL', 'error')} All apps have null AutoRotateStatus. This indicates a permissions issue reading Custom Security Attributes.</p>`;
                    html += `<p>Check: (1) <code>CustomSecAttributeAssignment.Read.All</code> Graph permission, (2) <b>Attribute Assignment Reader</b> directory role.</p>`;
                } else if (apps.withAutoRotateNull > 0) {
                    html += `<p>${statusBadge('PARTIAL', 'warn')} Some apps have null AutoRotateStatus. Apps without the attribute set will show null.</p>`;
                } else if (apps.totalCount > 0) {
                    html += `<p>${statusBadge('ALL SET', 'ok')} All apps have AutoRotateStatus values.</p>`;
                }

                // App table
                if (apps.apps && apps.apps.length > 0) {
                    html += '<table><tr><th>Display Name</th><th>ID</th><th>AutoRotateStatus</th></tr>';
                    for (const app of apps.apps) {
                        const val = app.autoRotateStatus;
                        const badge = val === 'null' || !val
                            ? statusBadge('null', 'warn')
                            : val.toLowerCase() === 'on' ? statusBadge(val, 'ok')
                            : val.toLowerCase() === 'off' ? statusBadge(val, 'error')
                            : statusBadge(val, 'info');
                        html += `<tr><td>${esc(app.displayName)}</td><td style="font-size:11px">${esc(app.id)}</td><td>${badge}</td></tr>`;
                    }
                    html += '</table>';
                }
            }

            // Raw JSON
            html += '<h3>Raw API Response</h3>';
            html += `<pre>${esc(JSON.stringify(data, null, 2))}</pre>`;
            html += '</div>';
            out().innerHTML += html;
        }

        function renderVerdict(authMe, apiDiag) {
            let html = '<div class="card"><h2>3. Diagnosis Summary</h2>';
            const issues = [];
            const fixes = [];

            // Check role enrichment
            const principal = authMe ? (Array.isArray(authMe) ? authMe[0]?.clientPrincipal : authMe?.clientPrincipal) : null;
            const swaRoles = principal?.userRoles || [];
            const hasCustomRoles = swaRoles.includes('admin') || swaRoles.includes('reader');

            if (!hasCustomRoles && principal) {
                issues.push('SWA /.auth/me does NOT include admin/reader roles. GetRoles may not be called by SWA.');
                fixes.push('1. Verify staticwebapp.config.json was deployed with __TENANT_ID__ replaced with actual tenant ID.');
                fixes.push('2. Verify rolesSource is set to "/api/GetRoles" in deployed staticwebapp.config.json.');
                fixes.push('3. Log out completely (/.auth/logout) and log back in — SWA only calls GetRoles during login.');
                fixes.push('4. Check App Insights for GetRoles invocations or errors.');
            }

            // Check CSA
            if (apiDiag?.samlApps && !apiDiag.samlApps.error) {
                if (apiDiag.samlApps.withAutoRotateNull === apiDiag.samlApps.totalCount && apiDiag.samlApps.totalCount > 0) {
                    issues.push('All SAML apps have NULL AutoRotateStatus — Graph API CSA permissions likely missing.');
                    fixes.push('A. Grant CustomSecAttributeAssignment.Read.All Graph API permission to managed identity (Step 5.1).');
                    fixes.push('B. Assign Attribute Assignment Reader directory role to managed identity (Step 5.2).');
                    fixes.push('C. Restart Function App after permission changes and wait for propagation.');
                }
            } else if (apiDiag?.samlApps?.error) {
                issues.push(`Graph API error: ${apiDiag.samlApps.error}`);
            }

            // Check config
            const config = apiDiag?.configuration;
            if (config) {
                const hostname = config.swA_HOSTNAME ?? config.swa_HOSTNAME;
                const defaultHostname = config.swA_DEFAULT_HOSTNAME ?? config.swa_DEFAULT_HOSTNAME;
                if ((!hostname || hostname === 'NOT SET') && (!defaultHostname || defaultHostname === 'NOT SET')) {
                    issues.push('Neither SWA_HOSTNAME nor SWA_DEFAULT_HOSTNAME is configured on Function App.');
                    fixes.push('Set SWA_DEFAULT_HOSTNAME in Function App settings to your SWA hostname.');
                }
            }

            if (issues.length === 0) {
                html += `<p>${statusBadge('ALL CHECKS PASSED', 'ok')} No issues detected.</p>`;
            } else {
                html += `<p>${statusBadge(issues.length + ' ISSUE(S) FOUND', 'error')}</p>`;
                html += '<h3>Issues</h3><ul>';
                for (const issue of issues) {
                    html += `<li style="margin:4px 0;color:#ef9a9a">${esc(issue)}</li>`;
                }
                html += '</ul>';
                html += '<h3>Suggested Fixes</h3><ul>';
                for (const fix of fixes) {
                    html += `<li style="margin:4px 0;color:#a5d6a7">${esc(fix)}</li>`;
                }
                html += '</ul>';
            }

            html += '</div>';
            out().innerHTML += html;
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            setTimeout(runAllDiagnostics, 500);
        });
    </script>
</body>
</html>
